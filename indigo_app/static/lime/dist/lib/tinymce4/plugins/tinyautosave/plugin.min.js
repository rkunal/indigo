/*
	TinyAutoSave 2.1.3 March 19, 2011) plugin for TinyMCE
	http://tinyautosave.googlecode.com/
	Copyright (c) 2008-2011 Todd Northrop
	http://www.speednet.biz/
	Dual licensed under the MIT or GPL Version 2 licenses.
	September 16, 2013 -> CIRSFID updated for tinymce 4 compability
*/
(function(){function z(){var a=g[this.key];a.timer&&window.clearInterval(a.timer);tinymce.dom.Event.unbind(window,"unload",a.saveFinalDelegate);a.askBeforeUnload&&tinymce.dom.Event.unbind(window,"unload",tinymce.plugins.AutoSavePlugin._beforeUnloadHandler);this.editor.onRemove.remove(a.saveFinalDelegate);delete g[this.key]}function p(a){if(!a)return!0;var b,c;b=tinymce.is;if(b(a,"string"))(b=u[a])?c=b[a]:u[a]=c=tinymce.resolve(a);else if(b(a,"function"))c=a;else return!0;return c.apply(this)}function v(){var a= g[this.key];a.saveDelegate();a.disposeDelegate()}function w(){var a=this.editor,b=g[this.key],c=tinymce.is,e=!1,A=new Date,d,l,k,h;if(a&&!b.busy){b.busy=!0;d=a.getContent();if(c(d,"string")&&d.length>=b.minSaveLength){if(!p.call(this,this.onPreSave))return b.busy=!1;c=new Date(A.getTime()+6E4*b.retentionMinutes);try{m?localStorage.setItem(b.dataKey,c.toString()+","+d.replace(/,/g,"&#44;")):r?sessionStorage.setItem(b.dataKey,c.toString()+","+d.replace(/,/g,"&#44;")):q?B(this,d,c):(l=b.dataKey+"=", k="; expires="+c.toUTCString(),document.cookie=l+C(d).slice(0,4096-l.length-k.length)+k),e=!0}catch(n){p.call(this,this.onSaveError)}e&&(a=a.controlManager,b.canRestore=!0,a.setDisabled(f,!1),this.showSaveProgress&&(k=tinymce.DOM.get(a.get(f).id))&&(h=b.restoreImage,k.firstChild.src=b.progressImage,window.setTimeout(function(){k.firstChild.src=h},Math.min(this.progressDisplayTime,1E3*b.intervalSeconds-100))),p.call(this,this.onPostSave))}b.busy=!1}return e}function x(){var a=this,b=a.editor,c=g[a.key], e=null,h=tinymce.is,d,l;if(b&&c.canRestore&&!c.busy){c.busy=!0;if(p.call(a,a.onPreRestore))try{m||r?(e=((m?localStorage.getItem(c.dataKey):sessionStorage.getItem(c.dataKey))||"").toString(),d=e.indexOf(","),e=-1==d?null:D(e.slice(d+1,e.length))):q?e=y(a):(l=c.cookieFilter.exec(document.cookie))&&(e=E(l[1])),h(e,"string")?0===b.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length?(b.setContent(e),p.call(a,a.onPostRestore)):b.windowManager.confirm(f+".warning_message",function(d){d&& (b.setContent(e),p.call(a,a.onPostRestore));c.busy=!1},a):b.windowManager.alert(f+".no_content")}catch(k){p.call(a,a.onRestoreError)}c.busy=!1}}function B(a,b,c){h.setAttribute(g[a.key].dataKey,b);h.expires=c.toUTCString();h.save("TinyMCE")}function y(a){h.load("TinyMCE");return h.getAttribute(g[a.key].dataKey)}function C(a){return a.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(a){return 1<a.length?"%0"+a.charAt(0)+a.length.toString()+"%":F[a]})}function E(a){return a.replace(/%[1-5]|%0(.)(\d+)%/g, function(a,c,e){var f;if(2==a.length)return G[a];a=[];f=0;for(e=parseInt(e);f<e;f++)a.push(c);return a.join("")})}function D(a){return a.replace(/&#44;/g,",")}function n(a,b){return function(){return b.apply(a)}}function H(a){var b=a.key,c=g[b];c||(c=g[b]=tinymce.extend({},s,{dataKey:s.dataKey+b,saveDelegate:n(a,w),saveFinalDelegate:n(a,v),restoreDelegate:n(a,x),disposeDelegate:n(a,z),cookieFilter:RegExp("(?:^|;\\s*)"+s.dataKey+b+"=([^;]*)(?:;|$)","i")}));return c}var f="tinyautosave",m=!1,r=!1,q= !1,F={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"},G={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"},t=[],g={},u={},h=null,s={dataKey:"TinyAutoSave",cookieFilter:null,saveDelegate:null,saveFinalDelegate:null,restoreDelegate:null,disposeDelegate:null,restoreImage:"",progressImage:"progress.gif",intervalSeconds:60,retentionMinutes:20,minSaveLength:50,askBeforeUnload:!1,canRestore:!1,busy:!1,timer:null};try{localStorage.setItem("TinyAutoSave_Test_","OK"),"OK"===localStorage.getItem("TinyAutoSave_Test_")&& (localStorage.removeItem("TinyAutoSave_Test_"),m=!0)}catch(I){try{sessionStorage.setItem("TinyAutoSave_Test_","OK"),"OK"===sessionStorage.getItem("TinyAutoSave_Test_")&&(sessionStorage.removeItem("TinyAutoSave_Test_"),r=!0)}catch(J){q=tinymce.isIE}}tinymce.PluginManager.requireLangPack(f);tinymce.create("tinymce.plugins.TinyAutoSavePlugin",{editor:null,url:"",key:"",onPreSave:null,onPostSave:null,onSaveError:null,onPreRestore:null,onPostRestore:null,onRestoreError:null,showSaveProgress:!0,progressDisplayTime:1200, init:function(a,b){var c=this,e=tinymce.is,g=tinymce.resolve,d,l,k;c.editor=a;c.id=a.id;c.url=b;c.key=a.getParam(f+"_key",a.id);d=H(c);d.restoreImage=b+"/images/restore."+(tinymce.isIE6?"gif":"png");c.setProgressImage(b+"/images/"+s.progressImage);d.intervalSeconds=Math.max(1,parseInt(a.getParam(f+"_interval_seconds",null)||a.getParam(f+"_interval",d.intervalSeconds)));d.retentionMinutes=Math.max(1,parseInt(a.getParam(f+"_retention_minutes",null)||a.getParam(f+"_retention",d.retentionMinutes)));d.minSaveLength= Math.max(1,parseInt(a.getParam(f+"_minlength",d.minSaveLength)));c.showSaveProgress=a.getParam(f+"_showsaveprogress",c.showSaveProgress);d.askBeforeUnload=a.getParam(f+"_ask_beforeunload",d.askBeforeUnload);d.saveDelegate=n(c,w);d.saveFinalDelegate=n(c,v);d.restoreDelegate=n(c,x);a.addCommand("mceTinyAutoSave",d.saveDelegate);a.addCommand("mceTinyAutoSaveRestore",d.restoreDelegate);a.addButton(f,{title:f+".restore_content",cmd:"mceTinyAutoSaveRestore",image:d.restoreImage});d.timer=window.setInterval(d.saveDelegate, 1E3*d.intervalSeconds);tinymce.dom.Event.bind(window,"unload",d.saveFinalDelegate);a.onRemove.add(d.saveFinalDelegate);d.askBeforeUnload&&tinymce.dom.Event.bind(window,"unload",tinymce.plugins.AutoSavePlugin._beforeUnloadHandler);a.onInit.add(function(){q&&(h||(h=a.getElement()),h.style.behavior="url('#default#userData')");d.canRestore=c.hasSavedContent();l=a.getParam(f+"_oninit",null);e(l,"string")&&(k=g(l),e(k,"function")&&k.apply(c));a.controlManager.setDisabled(f,!d.canRestore)})},getInfo:function(){return{longname:"TinyAutoSave", author:"Speednet",authorurl:"http://www.speednet.biz/",infourl:"http://tinyautosave.googlecode.com/",version:"2.1.3"}},clear:function(){var a=this.editor,b=g[this.key];m?localStorage.removeItem(b.dataKey):r?sessionStorage.removeItem(b.dataKey):q?h.removeAttribute(g[this.key].dataKey):tinymce.util.Cookie.remove(b.dataKey);b.canRestore=!1;a.controlManager.setDisabled(f,this)},hasSavedContent:function(){var a=g[this.key],b=new Date,c,e;try{if(m||r){c=((m?localStorage.getItem(a.dataKey):sessionStorage.getItem(a.dataKey))|| "").toString();e=c.indexOf(",");if(8<e&&e<c.length-1){if(new Date(c.slice(0,e))>b)return!0;m?localStorage.removeItem(a.dataKey):sessionStorage.removeItem(a.dataKey)}return!1}return q?0<(y(this)||"").length:0<(tinymce.util.Cookie.get(a.dataKey)||"").length}catch(f){return!1}},setProgressImage:function(a){if(tinymce.is(a,"string")){a=g[this.key].progressImage=a;var b=t.length;t[b]=new Image;t[b].src=a}},"static":{_beforeUnloadHandler:function(){var a;tinymce.each(tinyMCE.editors,function(b){if(!b.getParam("fullscreen_is_enabled")&& b.isDirty())return a=b.getLang("autosave.unload_msg"),!1});return a}}});tinymce.PluginManager.add(f,tinymce.plugins.TinyAutoSavePlugin)})();